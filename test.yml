- name: downloading stack patch file from artifactory
  get_url:
    url: https://artifactory.ah.technology/artifactory/software/p{{stack_patch}}_122140_Generic.zip
    dest: "{{ oracle_patch_dir }}"
    username: "{{ username }}"
    password: "{{ apikey }}"
    mode: "0755"
- name: downloading patch files from artifactory
  vars:
    patches:
      - name: downloading owsm_patch patch from artifactory
        url: https://artifactory.ah.technology/artifactory/software/p36769312_122140_Generic.zip
        dest: "{{ oracle_patch_dir }}"
        exctract_dir: "{{ oracle_patch_dir }}"
        username: "{{ username }}"
        password: "{{ apikey }}"
        mode: "0755"
      - name: downloading adf_patch patch from artifactory
        url: https://artifactory.ah.technology/artifactory/software/p36700543_122140_Generic.zip
        dest: "{{ oracle_patch_dir }}"
        exctract_dir: "{{ oracle_patch_dir }}"
        username: "{{ username }}"
        password: "{{ apikey }}"
        mode: "0755"
      - name: downloading vul_patch patch from artifactory
        url: https://artifactory.ah.technology/artifactory/software/p34809489_122140_Generic.zip
        dest: "{{ oracle_patch_dir }}"
        exctract_dir: "{{ oracle_patch_dir }}"
        username: "{{ username }}"
        password: "{{ apikey }}"
        mode: "0755"
      - name: downloading spu_patch patch from artifactory
        url: https://artifactory.ah.technology/artifactory/software/p36733887_122140_Generic.zip
        dest: "{{ oracle_patch_dir }}"
        exctract_dir: "{{ oracle_patch_dir }}"
        username: "{{ username }}"
        password: "{{ apikey }}"
        mode: "0755"
- name: extracting downloaded stack patch file
  unarchive:
    src: "{{ oracle_patch_file }}"
    dest: "{{ oracle_patch_dir }}"
    mode: "0755"
    remote_src: yes
- tasks:
    - name: download patch file
      get_url:
        url: "{{ item.url }}"
        dest: "{{ item.dest }}"
      with_items: "{{ patches }}"
    - name: Extract patches
      unarchive:
        src: "{{ item.dest }}"
        dest: "{{ item.extract_dir }}"
        remote_src: yes
      with_items: "{{ patches }}"
- name: running spbat pre check phase
  shell: ' {{oracle_patch_dir}}/WLS_SPB_12.2.1.4.{{patch_date}}/{{spbat_path}}/spbat.sh -phase precheck -oracle_home {{oracle_home}} '
  register: patch_precheck_status
- debug:
    var: patch_precheck_status.stdout_lines
- name: backing up oracle home, domain home and oraInventory
  archive:
    path: "{{ item.path }}"
    dest: "{{ item.dest }}"
  with_items:
    - path: "{{ oracle_home }}"
      dest: "{{ oracle_dir }}/oracle_home_backup.tgz"
    - path: "{{ domain_home }}"
      dest: "{{ oracle_dir }}/domain_home_backup.tgz"
    - path: "{{ oracle_inventory }}"
      dest: "{{ oracle_dir }}/ora_Inventory_backup.tgz"
  async: 60
  poll: 0